## 5장 안정 해시 설계   

요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다.  

### 해시 키 재배치 문제  

서버들에 부하를 균등하게 나누는 보편적인 방법은 해시 함수를 사용하는 것이다.  

`serverIndex = hash(key)%N`  

위와 같이 되어있을 때, 클라이언트는 캐시에 보관된 데이터를 가져오기 위해 해당 서버를 이용한다.  

위의 방법은 서버 풀의 크기가 고정되어 있고, 데이터 분포가 균등하할 때 잘 동작한다.  
만약 서버가 추가가 되거나, 기존의 서버가 삭제된다면 균등하게 분포되지 않는다.  


### 안정 해시  

안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다.
(k: 키의 개수, n: 슬롯의 개수)  

**동작 원리**  
해시 함수로 `SHA-1`를 사용하고 함수의 출력 값 범위는 x0, x1부터 xn까지 있다.  
SHA-1의 범위는 2의 100승 -1 까지이기에 x0은 0, ~, xn는 2의 100승-1값을 가진다.

해시 공간의 양쪽을 구부려 잡아 해시링을 만든다.    

  

**해시 함수**  

해시 함수 f를 이용해서 서버 ip나 이름을 이 링 위에 어떤 위치에 대응시킬 수 있다.  


**해시 키**  

캐시할 키 또한 해시 링 위의 어느 지점에 배치할 수 있다.  


**서버 조회** 

어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫번째 서버다.  

**서버 추가**  

서버를 추가하더라도 키 가운데 일부만 재배치하면 된다. 

**서버 제거**  

하나의 서버가 제거되면 키 가운데 일부만 재배치된다.  
나머지 키에는 영향이 없다.  

**기본 구현의 두가지 문제**  

서버의 키를 균등 분포 해시 함수를 사용해 해시 링에 배치한다.  
키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버이다.  


**안정 해시의 이점**  

서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화 된다.  
데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.  
핫스팟(hotspot) 키 문제를 줄인다. 특정한 샤드(shard)에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있다. 안정 해시는 데이터를 좀 더 균등하게 분배하므로 이런 문제가 생길 가능성을 줄인다.  
  

**안정 해시의 예시**    
아마존 다이나모 데이터베이스(DynamoDB)의 파티셔닝 관련 컴포넌트  
아파치 카산드라(Apache Cassandra) 클러스터에서의 데이터 파티셔닝  
디스코드(Discord)채팅 어플리케이션  
아카마이(Akamai) CDN  
매그래프(Meglev) 네트워크 부하 분산기  

예시 정보: https://discord.com/blog/how-discord-scaled-elixir-to-5-000-000-concurrent-users