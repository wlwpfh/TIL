## KMS (Key Management Service)

aws 내에서 암호화는 KMS 암호화를 뜻하는 것이다.

KMS 서비스가 암호화 키를 관리한다는 개념이다.

승인에 관해 IAM와 완벽하게 통합되어 있다.

KMS로 암호화되어 있다면 데이터에 대한 접근이 쉬워진다.

cloudtrail을 통해 키를 사용하기 위해 이뤄진 모든 api 호출을 감시할 수 있다.

대부분의 aws 서비스에서 원활하게 사용할 수 있다.

만약 비밀 데이터가 있다면 절대로 평문 텍스트에 저장하지 말아야 한다.

KMS를 사용하려 한다면 api 호출을 통해서도 KMS를 사용할 수 있다.

### 다양한 유형의 KMS  키

옛날에는 KMS 고객 마스터 키라고 불렀다.

1. 대칭 KMS 키(AES-256) = 데이터를 암/복호화하는데 사용되는 암호화 키가 하나만 있다.

   KMS가 통합된 모든 aws 서비스는 대칭 키를 사용한다.

   KMS 대칭 키를 생성하거나 사용할 때 키 자체에는 절대 접근할 수 없다.

   → 단지 aws api 호출을 이용해서 KMS 키를 이용할 뿐

2. 비대칭 KMS 키(RSA & ECC) = 키가 두개가 있다는 뜻

   하나는 암호화하는데 사용되는 퍼블릭 키 / 하나는 데이터를 복호화하는데 사용되는 프라이빗 키이다.

   암호화/복호화 하거나 서명/확인 형태의 작업을 할 때 사용하게 된다.

   KMS에서 퍼블릭 키를 다운로드 할 수 있지만 프라이빗 키에는 액세스할 수 없다.


### KMS 키의 종류

1. aws가 소유한 키  (aws owned key)

   무료이며 우리가 SSE-S3 타입의 암호화를 사용하거나 SSE dynamoDB를 사용할 때 사용하는 키이다.

2. aws 관리형 키 (aws managed key)

   무료이며 앞에 aws/가 있고 서비스 이름이 나오기 때문에 알아볼 수 있다. aws/rds, aws/ebs 등

   키가 지정된 서비스 안에서만 사용될 수 있다.

3. 고객 관리형 키

   한달에 1달러의 비용이 발생한다.

4. 고객 관리형 키 imported (대칭 키어야 함)

KMS도 가격 책정되어 있다. 서비스에 대해 이뤄진 api 호출 건에 대해 지불하게 된다.

1. 자동 키 순호나 (automatic key rotation)

   키가 aws 관리형 KMS 키라면 자동으로 1년마다 순환된다.

   KMS 안에서 생성한 고객 관리형 키라면 우리가 자동 순환을 화성화 해야 한다.

   임포트한 KMS 키라면 수작업으로만 순환시킬 수 있다.


### KMS 키와 리전

KMS 키의 범위는 리전이다.

다른 리전에 사용되는 KMS 키를 다른 리전에 복사하고 싶다면 몇 가지 단계를 거쳐야 한다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/0e50c9f9-d6b9-4369-b0d8-a40d14ac1451/8e68de66-9d3f-4681-837f-67f1641617e8/Untitled.png)

1. ebs 볼륨의 스냅샷을 찍어야 한다.
2. 암호화된 스냅샷의 스냅샷을 찍으면 이 스냅샷 자체도 동일한 KMS 키로 암호화될 것이다.
3. 스냅샷을 다른 리전에 복사하기 위해 다른 KMS 키를 사용해서 그 스냅샷을 다시암호화해야 한다.

+) 하지만 동일한 KMS 키가 두 리전에 있을 수 없다.

1. KMS를 이용해서 스냅샷을 원래의 ebs 볼륨으로 복구한다.

### KMS 키 정책

1. s3 버킷 정책과 비슷하다.
2. 우리의 키에 KMS 키 정책이 없다면 아무도 키에 접근할 수 없다.

- 기본 KMS 키 정책
1. 특정한 커스텀 KMS 키 정책을 제공하지 않았을 때 생성된다.
2. 우리 계정에 있는 모든 사람이 이 키에 접근하도록 허용하는 것이다.
- 커스텀 KMS 키 정책
1. KMS 키에 접근할 수 있는 사용자와 역할을 정의한다.
2. 키를 누가 관리할 수 있는지 정의한다.
3. KMS 키에 대한 교차 계정 액세스를 하려는 경우에 유용하다.

### 암호화된 스냅샷을 계정들 간에 복사하고 싶을 때

1. 암호화된 스냅샷을 생성한다.

→ 커스텀 키 정책을 첨부해야 하기 때문에 고객 관리형 KMS 키가 되어야 한다.

1. 교차 계정 액세스를 승인하기 위한 KMS 키 정책을 첨부한다.
2. 암호화된 스냅샷을 타깃 계정과 공유한다.
3. 타깃 계정 안에서 스냅샷의 사본을 생성하고 다른 고객 관리형 키를 사용해서 그 타깃 계정 안에서 암호화한다.
4. 그러면 타깃 계정 안에서 스냅샷으로부터 볼륨을 생성할 수 있다.

### KMS 다중 리전 키

KMS에는 다중 리전 키를 둘 수 있다. = 선택된 한 리전에 기본 키를 갖는다

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/0e50c9f9-d6b9-4369-b0d8-a40d14ac1451/5d0896e0-ff53-4403-83c6-3a8affeaebda/Untitled.png)

유사해보이는 이유는 키 구성 요소가 복제되기 때문이다.

키 id가 완전히 똑같다.

1. 다른 aws 리전에서 사용할 수 있는 KMS 키 세트로 서로 교차해서 사용할 수 있다.

→ 한 리전에서 암호화한 다음 다른 리전에서 복호화할 수 있다.

1. 다중 리전 키는 동일한 키 id와 동일한 키 구성 요소를 갖는다.

+) 기본 키의 자동 교체를 활성화했고 실제로 자동으로 교체된 키는 다른 리전에도 복제된다.

1. 한 리전에서 암호화하고 다른 리전에서 복호화한다.
2. 다음 리전으로 복제할 때나 교차 리전 api 호출을 실행할 때 데이터를 재암호화하지 않아도 된다.

++) KMS 다중 리전 키는 전역으로 사용할 수 없다!!

그냥 기본 키가 있고 복제본이 있는 것이다.

+++) 각 다중 리전키는 자체 키 정책 등으로 각각 독립적으로 관리된다.

특정 사례를 제외하고는 다중 리전 키 사용을 권장하지 않는다.

사용 사례: 전역 클라이언트 측 암호화, dynamoDb 전역 테이블/global aurora에서 암호화

### dynamoDB 전역 테이블과 KMS 다중 리전 키를 클라이언트 측 암호화하는 원리

포인트는 전체 테이블만 암호화하는 것이 아니다!!

→ 저장 데이터 암호화이기에 테이블의 속성을 암호화하여 특정 클라이언트만 사용할 수 있게 된다.

⇒ 이 때 amazon dynamoDB 암호화 클라이언트를 사용한다.

dynamoDB 테이블이 전역 테이블인 경우 해당 테이블의 데이터는 다른 리전으로 복제된다.

클라이언트 측 암호화 기술을 사용하면 데이터의 특정 필드나 속성을 보호할 수 있다.

api 키 접근 권한이 있는 클라이언트만 복호화할 수 있다.

### global aurora와 KMS 다중 리전 키를 클라이언트 측 암호화하는 원리

aws encrpytion sdk를 사용한다.

전역 데이터베이스이기에 테이블이 전역으로 복제된다.