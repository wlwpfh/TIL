## cloudtrail

aws 계정의 거버넌스, 컴플라이언스. 감사를 실현하는 방법이다.

cloudtrail은 기본으로 설정되어 있다.

cloudtrail을 사용하면 aws 계정 안에서 일어난 모든 이벤트와 api 호출 이력을 콘솔, sdk. cli/ 기타 서비스를 통해 얻을 수 있다.

모든 로그가 cloudtrail에 나타나게 된다.

로그를 clouwatch logs, s3에 넣을 수 있다.

모든 리전에 걸쳐 누적된 이벤트 이력을 하나의 특정한 s3 버킷에 넣고 싶다면 트레일을 생성해서 모든 리전이나 하나의 리전에 적용할 수 있다.

### cloudtrail event

1. 관리 이벤트

   : aws 계정 안에서 리소스에 대해 수행된 작업을 나타낸다.

   : 모든 관리 이벤트를 로깅하도록 설정되어 있다.

   : 이벤트 안에서도 리소스를 변경하지 않는 읽기 이벤트가 있고, ㅅ수정할 수 있는 쓰기 이벤트가 있다.

1. 데이터 이벤트

   : 기본값으로 데이터 이벤트는 로깅되지 않는다. → 고용량 작업이다.

   : 예를 들어 amazon s3 객체 수준 활동이 있다.

   : 읽기 이벤트와 쓰기 이벤트를 분리할 수 있다.

   : aws 람다 함수 실행 활동이 있다.

1. cloudtrail insight 이벤트

   : 계정에서 일어나는 이벤트를 분석하고 비정상적인 활동에 대한 탐지를 시도한다.

   : ex) 부정확한 리소스 프로비저닝, 서비스 한도 도달, aws iam 액션의 폭증, 주기적 유지보수 활동 누락 등

   : 정상적인 관리 활동을 분석해서 기준선을 만든다.

   : 그리고 올바른 형태의 이벤트인지 모든 걸 계속적으로 분석한다.

### cloudtrail events retention

기본적으로 이벤트는 90일동안 보관된다.

이후에 이벤트를 보관하려면 s3에 보내고 athena로 분석하면 된다.

---

## eventbridge - api 호출 가로채기

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/0e50c9f9-d6b9-4369-b0d8-a40d14ac1451/a9efc3ab-b286-4396-8210-1e7d1c9c52b8/Untitled.png)

사용자가 DeleteTable api 호출을 사용하여 테이블을 삭제하는 경우 sns 알림을 받고 싶다면?

이 호출은 cloudtrail에 기록도니다.

이 이벤트는 eventbridge로 넘겨지고 대상은 sns가 된다.

---

## aws config

aws 내 리소스에 대한 감사와 규정 준수 여부를 기록할 수 있게 해주는 서비스이다.

설정된 규칙에 기반해 구성과 구성의 시간에 따른 변화를 기록할 수 있으며 이를 통해 인프라를 통해 문제점을 찾아낼 수 있다.

이걸로 해결할 수 있는 문제들

: 보안 그룹에 제한되지 않은 ssh 접근이 있나?

: 버킷에 공용 액세스가 있나?

: 시간이 지나면서 변한 alb 구성이 있나?

변화가 생길 때마다 sns 알림을 받을 수 있다.

리전별 서비스이기 때문에 모든 리전별로 구성해야 하며 데이터를 중앙화하기 위해 리전과 계정 간 데이터를 통합할 수 있다.

모든 리소스의 구성을 s3에 저장해 나중에 분석할 수 있다.

### config rules

1. aws 관리형 config 규칙이 있다.
2. 스스로 config 규칙을 만들 수 있다 - 람다를 이용해 스스로 규칙을 정의해야 한다.
3. 몇몇 규칙들은 구성이 변화할 때마다 평가되거나 트리거 된다.
4. config 규칙은 규정 준수를 위한 것이다. 동작을 미리 예방/차단할 수 없다.
5. 결제 서비스이다 ^ ^

### aws config resource

리소스의 규정 준수 여부를 시간별로 볼 수 있다.

리소스 구성도 시간별로 볼 수 있다.

이를 cloudtrail과 연결해 api 호출을 볼 수 있다.

### config rules - remediations

ssm 자동화 문서를 이용해서 규정을 준수하지 않은 리소스를 수정할 수 있다.

리소스가 규정을 미준수할 때마다 수정 작업을 트리거할 수는 있다.

그리고 이 수정 작업은 재시도될 수 있다.

### config rules - nofitication

eventbridge를 사용해 리소스가 규정을 미준수할 때마다 알림을 보낼 수 있다.

모든 구성 변경과 모든 리소스의 규정 준수 여부 알림을 sns로 보낼 수 있다.